<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firma Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.22.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { GoogleGenAI } from "https://aistudiocdn.com/@google/genai@^1.22.0";

      // --- CONSTANTS ---
      const STATUS_OPTIONS = [
        'Aranacak',
        'Arandı - Ulaşılamadı',
        'Arandı - Anlaşıldı',
        'Arandı - İlgilenmiyor',
        'Tekrar Aranacak',
        'Randevu Alındı'
      ];
      
      const statusStyles = {
        'Aranacak': 'bg-sky-100 text-sky-800 dark:bg-sky-900/60 dark:text-sky-300 border-sky-300',
        'Arandı - Ulaşılamadı': 'bg-orange-100 text-orange-800 dark:bg-orange-900/60 dark:text-orange-300 border-orange-300',
        'Arandı - Anlaşıldı': 'bg-green-100 text-green-800 dark:bg-green-900/60 dark:text-green-300 border-green-300',
        'Arandı - İlgilenmiyor': 'bg-red-100 text-red-800 dark:bg-red-900/60 dark:text-red-300 border-red-300',
        'Tekrar Aranacak': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/60 dark:text-yellow-300 border-yellow-300',
        'Randevu Alındı': 'bg-purple-100 text-purple-800 dark:bg-purple-900/60 dark:text-purple-300 border-purple-300',
      };

      // --- ICONS ---
      const ArchiveIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4" />
          <path strokeLinecap="round" strokeLinejoin="round" d="m21 7.5-3.75 0-2.25-3-4.5 0-2.25 3-3.75 0" />
        </svg>
      );
      const TrashIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
        </svg>
      );
      const XIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      );
      const ArrowLeftIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
      );
      const ClipboardDocumentIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
        </svg>
      );

      const PaperAirplaneIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
        </svg>
      );
       const PhotoIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
        </svg>
    );
      const SpinnerIcon = (props) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          fill="none" 
          viewBox="0 0 24 24"
          className={`animate-spin ${props.className || ''}`}
          {...props}
        >
          <circle 
            className="opacity-25" 
            cx="12" 
            cy="12" 
            r="10" 
            stroke="currentColor" 
            strokeWidth="4"
          ></circle>
          <path 
            className="opacity-75" 
            fill="currentColor" 
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );
       const KeyIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
        </svg>
       );
       const CheckCircleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        );
      const InboxArrowDownIcon = (props) => (
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
      );
      const ChevronDownIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
        </svg>
      );
    const SearchIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
    );
     const ListBulletIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
        </svg>
    );
    const ChartPieIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
        </svg>
    );
    const WhatsAppIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.35 3.45 16.86L2.05 22L7.31 20.62C8.75 21.41 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M12.04 3.67C16.56 3.67 20.28 7.39 20.28 11.91C20.28 16.43 16.56 20.15 12.04 20.15C10.48 20.15 8.99 19.76 7.7 19.05L7.04 18.68L4.83 19.3L5.5 17.15L5.15 16.46C4.38 15.11 3.8 13.55 3.8 11.91C3.8 7.39 7.52 3.67 12.04 3.67M9.16 7.64C8.96 7.64 8.78 7.64 8.62 7.64C8.4 7.64 8.1 7.71 7.85 7.95C7.6 8.18 7.04 8.71 7.04 9.71C7.04 10.71 7.88 11.68 8.02 11.85C8.15 12.02 9.16 13.6 10.72 14.33C12.64 15.26 13.01 15.11 13.48 15.08C13.95 15.04 14.86 14.5 15.06 13.91C15.26 13.31 15.26 12.8 15.18 12.68C15.09 12.56 14.93 12.5 14.65 12.36C14.37 12.23 13.13 11.62 12.88 11.52C12.63 11.42 12.46 11.39 12.28 11.64C12.1 11.88 11.64 12.36 11.51 12.51C11.37 12.68 11.23 12.71 10.95 12.58C10.67 12.45 9.92 12.19 9.01 11.38C8.29 10.71 7.82 9.89 7.69 9.69C7.56 9.5 7.66 9.38 7.78 9.26C7.88 9.16 8.01 9 8.15 8.85C8.28 8.72 8.34 8.61 8.42 8.47C8.5 8.33 8.46 8.21 8.4 8.11C8.34 8.02 7.91 6.87 7.72 6.42" />
        </svg>
    );
    const PhoneIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 6.75Z" />
      </svg>
    );
    const UserGroupIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.952a4.5 4.5 0 0 1 4.5 0m-4.5 0a4.5 4.5 0 0 0-4.5 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 4.5a4.5 4.5 0 0 0 4.5 0m-4.5 0a4.5 4.5 0 0 0-4.5 0" />
        </svg>
    );
    const PlusCircleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
    );
    const CloudArrowUpIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" />
        </svg>
    );
    const CloudArrowDownIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0-3-3m3 3 3-3m-8.25 6a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" />
        </svg>
    );
    const DatabaseIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
        </svg>
    );
    const RocketLaunchIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
        </svg>
    );
    const DocumentTextIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
        </svg>
    );
    const ClockIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
    );
    const NoSymbolIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" />
        </svg>
    );


      // --- HOOKS ---
      function usePersistentState(key, initialValue) {
        const [state, setState] = useState(() => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : initialValue;
            } catch (error) {
                console.error("LocalStorage okuma hatası:", error);
                return initialValue;
            }
        });

        const [saveStatus, setSaveStatus] = useState('saved'); // saved, saving, error

        useEffect(() => {
            const saveData = async () => {
                setSaveStatus('saving');
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                    // Add a small delay to show 'saving' state
                    setTimeout(() => setSaveStatus('saved'), 500);
                } catch (error) {
                    console.error("LocalStorage yazma hatası:", error);
                    setSaveStatus('error');
                    if (error.name === 'QuotaExceededError') {
                        alert("KRİTİK HATA: Tarayıcı hafızası doldu! Yeni veriler kaydedilemiyor. Lütfen gereksiz firmaları silin veya 'Veri Transferi' bölümünden yedeğinizi indirip temizlik yapın.");
                    }
                }
            };

            saveData();
        }, [key, state]);

        return [state, setState, saveStatus];
      }

      // --- COMPONENTS ---
      
      const StorageStatus = ({ status, itemCount }) => {
        let message = "";
        let colorClass = "";
        
        if (status === 'saved') {
            message = "Otomatik Kaydedildi";
            colorClass = "text-green-600 dark:text-green-400";
        } else if (status === 'saving') {
            message = "Kaydediliyor...";
            colorClass = "text-yellow-600 dark:text-yellow-400";
        } else {
            message = "Kayıt Hatası!";
            colorClass = "text-red-600 dark:text-red-400 font-bold";
        }

        return (
            <div className="fixed bottom-4 left-4 bg-white dark:bg-gray-800 p-3 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 flex items-center gap-3 z-50 opacity-90 hover:opacity-100 transition-opacity">
                <DatabaseIcon className={`w-5 h-5 ${colorClass}`} />
                <div className="flex flex-col">
                    <span className={`text-xs font-semibold ${colorClass}`}>{message}</span>
                    <span className="text-[10px] text-gray-500 dark:text-gray-400">{itemCount} kayıt hafızada</span>
                </div>
            </div>
        );
      };
      
      const APIKeyManager = ({ apiKey, setApiKey }) => {
        const [keyInput, setKeyInput] = useState("");
        const [isEditing, setIsEditing] = useState(false);

        const handleSave = () => {
            if (keyInput.trim()) {
                setApiKey(keyInput.trim());
                setIsEditing(false);
            }
        };

        const handleEdit = () => {
            setIsEditing(true);
            setKeyInput(apiKey || "");
        };
        
        useEffect(() => {
            if (!apiKey) {
                setIsEditing(true);
            } else {
                setIsEditing(false);
            }
        }, [apiKey]);

        return (
            <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg h-full">
                <div className="flex items-center gap-4">
                    <div className="flex-shrink-0 text-sky-500">
                       <KeyIcon className="w-8 h-8"/>
                    </div>
                    <div className="flex-grow w-full">
                        <h3 className="font-semibold text-gray-900 dark:text-white">Google Gemini API Anahtarı</h3>
                        {isEditing ? (
                             <input
                                type="password"
                                value={keyInput}
                                onChange={(e) => setKeyInput(e.target.value)}
                                className="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white mt-1"
                                placeholder="API Anahtarınızı yapıştırın"
                            />
                        ) : apiKey ? (
                            <div className="flex items-center gap-2 text-green-600 dark:text-green-400 mt-1">
                                <CheckCircleIcon className="w-5 h-5" />
                                <p className="text-sm font-medium">API Anahtarı kaydedildi.</p>
                            </div>
                        ) : (
                             <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Lütfen devam etmek için API anahtarınızı girin.</p>
                        )}
                    </div>
                     {isEditing ? (
                        <button onClick={handleSave} className="bg-sky-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors">
                            Kaydet
                        </button>
                    ) : (
                        <button onClick={handleEdit} className="bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2.5 px-4 rounded-lg shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">
                            Değiştir
                        </button>
                    )}
                </div>
            </div>
        )
      };
      
      const DataTransferManager = ({ companyGroups, setCompanyGroups, displaySuccess, displayError }) => {
        const fileInputRef = useRef(null);

        const handleDownload = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(companyGroups));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "firma_arsivi_yedek.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            displaySuccess("Arşiv yedeği indirildi. Bu dosyayı başka bir bilgisayarda 'Yükle' diyerek açabilirsiniz.");
        };

        const handleUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        if(window.confirm("Yedek dosyasındaki veriler içeri aktarılacak. ÖNEMLİ: Sistem 'Akıllı Birleştirme' yapacaktır. Eğer yüklediğiniz dosyadaki bir firma (telefon numarasıyla) zaten Vercel'de kayıtlıysa, Vercel'deki güncel durumu (Arandı, Notlar vb.) KORUNACAK, dosyadaki eski bilgiyle ezilmeyecektir. Sadece yeni firmalar eklenecektir. Onaylıyor musunuz?")){
                             
                             const existingPhoneNumbers = new Set();
                             Object.values(companyGroups).flat().forEach(company => {
                                 if(company.phone) {
                                     existingPhoneNumbers.add(company.phone.replace(/\s/g, ''));
                                 }
                             });

                             let addedCount = 0;
                             let skippedCount = 0;

                             setCompanyGroups(prev => {
                                 const newGroups = { ...prev };
                                 
                                 Object.keys(importedData).forEach(groupName => {
                                     if(!newGroups[groupName]) {
                                         newGroups[groupName] = [];
                                     }

                                     const groupCompanies = importedData[groupName];
                                     groupCompanies.forEach(importedCompany => {
                                         const cleanPhone = importedCompany.phone ? importedCompany.phone.replace(/\s/g, '') : null;
                                         
                                         if (cleanPhone && existingPhoneNumbers.has(cleanPhone)) {
                                             skippedCount++;
                                         } else {
                                             const newCompany = { ...importedCompany, id: `${Date.now()}-${Math.random()}` };
                                             newGroups[groupName].push(newCompany);
                                             if(cleanPhone) existingPhoneNumbers.add(cleanPhone);
                                             addedCount++;
                                         }
                                     });
                                 });
                                 return newGroups;
                             });
                             
                             displaySuccess(`Akıllı Birleştirme Tamamlandı: ${addedCount} yeni firma eklendi. ${skippedCount} firma zaten sistemde mevcut olduğu için güncel durumları korundu.`);
                        }
                    } else {
                        displayError("Geçersiz yedek dosyası.");
                    }
                } catch (err) {
                    displayError("Dosya okunamadı: " + err.message);
                }
                e.target.value = null;
            };
            reader.readAsText(file);
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg h-full">
                <div className="flex items-center gap-4">
                    <div className="flex-shrink-0 text-purple-600">
                        <CloudArrowUpIcon className="w-8 h-8"/>
                    </div>
                    <div className="flex-grow w-full">
                        <h3 className="font-semibold text-gray-900 dark:text-white">Bilgisayar &lt;-&gt; Vercel Transferi</h3>
                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Bilgisayarınızdaki veriyi buraya (Vercel) atmak için <span className="font-bold">'Yükle'</span>, buradaki son hali bilgisayarınıza almak için <span className="font-bold">'İndir'</span> kullanın.
                            <br/>
                            <span className="text-green-600 dark:text-green-400 font-bold">Yükleme yaparken mevcut çalışma (arama durumu vb.) asla kaybolmaz.</span>
                        </p>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-2">
                         <button onClick={handleDownload} className="flex items-center gap-1 bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 text-sm transition-colors">
                            <CloudArrowDownIcon className="w-4 h-4"/> Yedeği İndir
                        </button>
                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-1 bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-purple-700 text-sm transition-colors">
                            <CloudArrowUpIcon className="w-4 h-4"/> Yükle
                        </button>
                        <input type="file" ref={fileInputRef} onChange={handleUpload} className="hidden" accept=".json" />
                    </div>
                </div>
            </div>
        );
      };

      const CompanyRow = ({ company, onDelete, onStatusChange }) => {
        const currentStatusStyle = statusStyles[company.status] || 'bg-gray-100 text-gray-800';

        return (
          <tr className="transition-colors duration-200 hover:bg-gray-50 dark:hover:bg-gray-700/50">
            <td className="px-6 py-4 whitespace-nowrap">
              <div className="font-medium text-gray-900 dark:text-white">
                {company.name}
              </div>
            </td>
            <td className="px-6 py-4">
              <div className="text-sm text-gray-500 dark:text-gray-300">
                {company.address}
              </div>
            </td>
            <td className="px-6 py-4 whitespace-nowrap">
              <div className="text-sm text-gray-500 dark:text-gray-300">
                {company.phone}
              </div>
            </td>
            <td className="px-6 py-4 whitespace-nowrap">
                <select 
                    value={company.status}
                    onChange={(e) => onStatusChange(company.id, e.target.value)}
                    className={`text-sm font-semibold p-2 rounded-lg border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-sky-500 transition-colors ${currentStatusStyle}`}
                >
                    {STATUS_OPTIONS.map(option => (
                        <option key={option} value={option}>{option}</option>
                    ))}
                </select>
            </td>
            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button 
                  onClick={() => onDelete(company.id)}
                  className="flex items-center gap-1 text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50 p-2 rounded-md transition-colors"
                  title="Sil"
                >
                  <TrashIcon className="w-5 h-5" />
                </button>
            </td>
          </tr>
        );
      };

      const CompanyTable = ({ companies, onDelete, onStatusChange }) => {
        return (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                  <thead className="bg-gray-50 dark:bg-gray-700/80">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Firma Adı</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Adres</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Telefon</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Durum</th>
                      <th scope="col" className="relative px-6 py-3">
                        <span className="sr-only">Eylemler</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                    {companies.map((company) => (
                      <CompanyRow 
                        key={company.id} 
                        company={company} 
                        onDelete={onDelete} 
                        onStatusChange={onStatusChange}
                      />
                    ))}
                  </tbody>
                </table>
            </div>
        );
      };
      
      const Header = () => {
        return (
          <header>
            <div>
              <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Firma Yönetim Paneli</h1>
              <p className="mt-1 text-gray-500 dark:text-gray-400">Firma kayıtlarını görüntüleyin, arşivleyin ve yönetin.</p>
            </div>
          </header>
        );
      };
      
      const CompanyGroup = ({ groupName, companies, onDelete, onStatusChange, onDeleteGroup }) => {
        const [isOpen, setIsOpen] = useState(false);
        
        const handleDeleteGroup = (e) => {
            e.stopPropagation();
            if(window.confirm(`'${groupName}' grubunu ve içindeki ${companies.length} firmayı kalıcı olarak silmek istediğinizden emin misiniz?`)){
                onDeleteGroup(groupName);
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                <div 
                    className="p-4 flex flex-col sm:flex-row justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                    onClick={() => setIsOpen(!isOpen)}
                >
                    <div className="flex items-center gap-3 w-full sm:w-auto mb-3 sm:mb-0 text-left">
                       <h2 className="text-xl font-bold text-gray-800 dark:text-gray-200 flex-grow">{groupName}</h2>
                       <span className="text-sm font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 px-2.5 py-1 rounded-full flex-shrink-0">
                          {companies.length} Firma
                       </span>
                   </div>
                    <div className="flex items-center gap-3">
                         <button 
                            onClick={handleDeleteGroup}
                            className="flex items-center gap-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors"
                            title="Bu Arşiv Grubunu Sil"
                        >
                           <TrashIcon className="w-5 h-5"/>
                           <span>Grubu Sil</span>
                        </button>
                         <ChevronDownIcon className={`w-6 h-6 text-gray-500 dark:text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </div>
                </div>

                {isOpen && (
                    <div className="border-t border-gray-200 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-900/50">
                        <CompanyTable
                            companies={companies}
                            onDelete={onDelete}
                            onStatusChange={onStatusChange}
                        />
                    </div>
                )}
            </div>
        );
      };

      const CompanyGroupList = ({ companyGroups, onDelete, onStatusChange, onDeleteGroup }) => {
        const groupNames = Object.keys(companyGroups);
        const totalCompanyCount = Object.values(companyGroups).reduce((acc, companies) => acc + companies.length, 0);

        if (totalCompanyCount === 0) {
             return (
                <div className="text-center bg-white dark:bg-gray-800 p-10 rounded-xl shadow-lg">
                  <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300">Henüz Firma Kaydı Yok</h2>
                  <p className="text-gray-500 dark:text-gray-400 mt-2">Başlamak için yukarıdan resim veya metin ile firma aktarın veya bilgisayarınızdaki yedeği yükleyin.</p>
                </div>
              );
        }

        if (groupNames.length === 0) {
            return (
                <div className="text-center bg-white dark:bg-gray-800 p-10 rounded-xl shadow-lg">
                    <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300">Sonuç Bulunamadı</h2>
                    <p className="text-gray-500 dark:text-gray-400 mt-2">Girdiğiniz filtre kriterlerine uygun firma bulunamadı. Filtreleri temizlemeyi deneyin.</p>
                </div>
            );
        }

        return (
          <div className="space-y-6">
            {groupNames.map(groupName => (
                <CompanyGroup
                    key={groupName}
                    groupName={groupName}
                    companies={companyGroups[groupName]}
                    onDelete={onDelete}
                    onStatusChange={onStatusChange}
                    onDeleteGroup={onDeleteGroup}
                />
            ))}
          </div>
        );
      };
      
      const TargetArchiveSelector = ({ targetArchive, setTargetArchive, existingData = [] }) => {
        // Extract unique values for autocomplete
        const suggestions = useMemo(() => {
            const s = { cities: new Set(), districts: new Set(), sectors: new Set() };
            existingData.forEach(c => {
                // Normalize for suggestion list
                if(c.city) s.cities.add(toTurkishTitleCase(c.city));
                if(c.district) s.districts.add(toTurkishTitleCase(c.district));
                if(c.sector) s.sectors.add(toTurkishTitleCase(c.sector));
            });
            return {
                cities: [...s.cities].sort(),
                districts: [...s.districts].sort(),
                sectors: [...s.sectors].sort()
            };
        }, [existingData]);

        // Helper to title case turkish string
        const toTurkishTitleCase = (str) => {
            if (!str) return "";
            return str.toLocaleLowerCase('tr-TR').split(' ').map(word =>
                word.charAt(0).toLocaleUpperCase('tr-TR') + word.slice(1)
            ).join(' ');
        };

        const handleInputChange = (e) => {
            const { name, value } = e.target;
            setTargetArchive(prev => ({ ...prev, [name]: value }));
        };
        
        // Auto-correct casing on blur
        const handleBlur = (e) => {
             const { name, value } = e.target;
             setTargetArchive(prev => ({ ...prev, [name]: toTurkishTitleCase(value) }));
        };

        const inputClass = "block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white";

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-1">1. Adım: Hedef Arşivi Belirleyin</h3>
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">Firmaları aktarmadan önce hangi arşive kaydedileceklerini belirtin.</p>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label htmlFor="target-city" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Şehir</label>
                        <input type="text" id="target-city" name="city" list="suggestions-city" value={targetArchive.city} onChange={handleInputChange} onBlur={handleBlur} className={inputClass} placeholder="Şehir girin..." />
                        <datalist id="suggestions-city">{suggestions.cities.map(item => <option key={item} value={item} />)}</datalist>
                    </div>
                    <div>
                        <label htmlFor="target-district" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">İlçe</label>
                        <input type="text" id="target-district" name="district" list="suggestions-district" value={targetArchive.district} onChange={handleInputChange} onBlur={handleBlur} className={inputClass} placeholder="İlçe girin..." />
                        <datalist id="suggestions-district">{suggestions.districts.map(item => <option key={item} value={item} />)}</datalist>
                    </div>
                    <div>
                        <label htmlFor="target-sector" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sektör</label>
                        <input type="text" id="target-sector" name="sector" list="suggestions-sector" value={targetArchive.sector} onChange={handleInputChange} onBlur={handleBlur} className={inputClass} placeholder="Sektör girin..." />
                         <datalist id="suggestions-sector">{suggestions.sectors.map(item => <option key={item} value={item} />)}</datalist>
                    </div>
                </div>
            </div>
        );
      };

       // ImageImporter & TextImporter omitted for brevity but should be here... (Same as before)
       // Re-implementing simplified versions to save space
       const ImageImporter = ({ onImport, isLoading, apiKey, isTargetArchiveValid }) => {
            const fileInputRef = useRef(null);
            const [file, setFile] = useState(null);
            
             const handleFileChange = (e) => { if (e.target.files && e.target.files.length > 0) setFile(e.target.files[0]); };
             const handleSubmit = (e) => { e.preventDefault(); if(file && apiKey && isTargetArchiveValid) onImport(file, () => setFile(null)); };
             
             return (
                 <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col">
                     <h3 className="text-lg font-semibold mb-2 dark:text-white">Resimden Firma Aktar</h3>
                     <input type="file" ref={fileInputRef} onChange={handleFileChange} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 dark:file:bg-gray-700 dark:file:text-white mb-4"/>
                     <button onClick={handleSubmit} disabled={!file || isLoading || !apiKey || !isTargetArchiveValid} className="mt-auto bg-sky-600 text-white py-2 px-4 rounded-lg disabled:opacity-50 hover:bg-sky-700">
                        {isLoading ? "Aktarılıyor..." : "Aktar"}
                     </button>
                 </div>
             )
       };

       const TextImporter = ({ onImport, isLoading, apiKey, isTargetArchiveValid }) => {
            const [text, setText] = useState("");
            const handleSubmit = (e) => { e.preventDefault(); if(text && apiKey && isTargetArchiveValid) onImport(text, () => setText("")); };

             return (
                 <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full flex flex-col">
                     <h3 className="text-lg font-semibold mb-2 dark:text-white">Metinden Firma Aktar</h3>
                     <textarea value={text} onChange={e => setText(e.target.value)} className="w-full h-32 p-2 border rounded-lg mb-4 dark:bg-gray-700 dark:text-white" placeholder="Firma bilgilerini yapıştırın..."/>
                     <button onClick={handleSubmit} disabled={!text || isLoading || !apiKey || !isTargetArchiveValid} className="mt-auto bg-sky-600 text-white py-2 px-4 rounded-lg disabled:opacity-50 hover:bg-sky-700">
                        {isLoading ? "Aktarılıyor..." : "Aktar"}
                     </button>
                 </div>
             )
       };
      
    const Filters = ({ filters, onFilterChange, allCompanies = [] }) => {
        const handleInputChange = (e) => {
            const { name, value } = e.target;
            onFilterChange({ ...filters, [name]: value });
        };
        const clearFilters = () => { onFilterChange({ searchTerm: '', sector: '', city: '', district: '', status: '' }); };
        const hasActiveFilters = Object.values(filters).some(val => val !== '');
        
        const getUniqueValues = (items, key) => [...new Set(items.map(item => item[key]?.trim()).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'tr'));
        const cities = useMemo(() => getUniqueValues(allCompanies, 'city'), [allCompanies]);
        const sectors = useMemo(() => getUniqueValues(allCompanies, 'sector'), [allCompanies]);
        const districts = useMemo(() => {
            let source = allCompanies;
            if (filters.city) source = allCompanies.filter(c => c.city === filters.city);
            return getUniqueValues(source, 'district');
        }, [allCompanies, filters.city]);

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                 <div className="relative">
                    <input type="search" name="searchTerm" value={filters.searchTerm} onChange={handleInputChange} className="block w-full rounded-lg border-gray-300 bg-gray-50 py-3 pl-4 pr-3 text-sm focus:border-sky-500 focus:ring-sky-500 dark:bg-gray-700 dark:text-white" placeholder="Firma adı, adres veya telefonda ara..." />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                     <select name="status" value={filters.status} onChange={handleInputChange} className="block w-full p-2.5 text-sm bg-gray-50 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white"><option value="">Durum: Tümü</option>{STATUS_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>
                     <select name="city" value={filters.city} onChange={handleInputChange} className="block w-full p-2.5 text-sm bg-gray-50 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white"><option value="">Şehir: Tümü</option>{cities.map(c => <option key={c} value={c}>{c}</option>)}</select>
                     <select name="district" value={filters.district} onChange={handleInputChange} className="block w-full p-2.5 text-sm bg-gray-50 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white"><option value="">İlçe: Tümü</option>{districts.map(d => <option key={d} value={d}>{d}</option>)}</select>
                     <select name="sector" value={filters.sector} onChange={handleInputChange} className="block w-full p-2.5 text-sm bg-gray-50 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white"><option value="">Sektör: Tümü</option>{sectors.map(s => <option key={s} value={s}>{s}</option>)}</select>
                </div>
                {hasActiveFilters && <button onClick={clearFilters} className="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-white">Filtreleri Temizle</button>}
            </div>
        );
    };

    const StagingArea = ({ companies, onDelete, onArchiveAll, onDeleteAll }) => {
        if (companies.length === 0) return null;
        return (
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold dark:text-white">Gelen Kutusu ({companies.length})</h2>
                    <div className="flex gap-2">
                        <button onClick={onArchiveAll} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Tümünü Arşivle</button>
                        <button onClick={onDeleteAll} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Temizle</button>
                    </div>
                </div>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                    {companies.map(c => (
                        <div key={c.id} className="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded border border-l-4 border-l-sky-500">
                             <div className="text-sm dark:text-gray-200"><span className="font-bold">{c.name}</span> - {c.phone}</div>
                             <button onClick={() => onDelete(c.id)} className="text-red-500 hover:text-red-700"><TrashIcon className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
            </div>
        );
    };
      
      const PageNavigator = ({ activePage, setActivePage }) => {
        const navItems = [
            { id: 'management', label: 'Firma Yönetimi', icon: ListBulletIcon },
            { id: 'analytics', label: 'Analiz', icon: ChartPieIcon },
            { id: 'whatsapp_pro', label: 'WhatsApp PRO', icon: RocketLaunchIcon },
        ];

        return (
            <div className="mb-8">
                <div className="sm:hidden">
                    <label htmlFor="tabs" className="sr-only">Sekme seç</label>
                    <select
                        id="tabs"
                        name="tabs"
                        className="block w-full rounded-md border-gray-300 focus:border-sky-500 focus:ring-sky-500 dark:bg-gray-800 dark:border-gray-600"
                        onChange={(e) => setActivePage(e.target.value)}
                        value={activePage}
                    >
                        {navItems.map((item) => <option key={item.id} value={item.id}>{item.label}</option>)}
                    </select>
                </div>
                <div className="hidden sm:block">
                    <div className="border-b border-gray-200 dark:border-gray-700">
                        <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                            {navItems.map((item) => {
                                const Icon = item.icon;
                                const isActive = activePage === item.id;
                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => setActivePage(item.id)}
                                        className={`group inline-flex items-center gap-2 whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium transition-colors ${
                                            isActive
                                                ? 'border-sky-500 text-sky-600 dark:text-sky-400'
                                                : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-gray-500 dark:hover:text-gray-200'
                                        }`}
                                    >
                                        <Icon className={`w-5 h-5 ${isActive ? 'text-sky-500' : 'text-gray-400 group-hover:text-gray-500 dark:group-hover:text-gray-300'}`} />
                                        {item.label}
                                    </button>
                                );
                            })}
                        </nav>
                    </div>
                </div>
            </div>
        );
       };


      const ManagementPage = ({
          targetArchive, setTargetArchive,
          handleImageImport, handleTextImport, loadingSource, apiKey, isTargetArchiveValid,
          globalError, globalSuccess,
          stagedCompanies, handleArchiveAllStaged, handleDeleteStagedCompany, handleDeleteAllStaged,
          filters, handleFilterChange,
          filteredCompaniesFlat,
          filteredCompanyGroups, handleDeleteCompany, handleStatusChange, handleDeleteGroup,
          allCompanies
      }) => {
          return (
              <div className="space-y-8">
                  <div className="space-y-6">
                      <TargetArchiveSelector targetArchive={targetArchive} setTargetArchive={setTargetArchive} existingData={allCompanies} />
                      
                      <div>
                          <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-1">2. Adım: Firmaları Aktarın</h3>
                          <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">Hedef arşivi belirledikten sonra firmaları aktarın.</p>
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                              <ImageImporter
                                  onImport={handleImageImport}
                                  isLoading={loadingSource === 'image'}
                                  apiKey={apiKey}
                                  isTargetArchiveValid={isTargetArchiveValid}
                              />
                              <TextImporter
                                  onImport={handleTextImport}
                                  isLoading={loadingSource === 'text'}
                                  apiKey={apiKey}
                                  isTargetArchiveValid={isTargetArchiveValid}
                              />
                          </div>
                      </div>
                       {globalError && <div className="mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md"><p className="font-bold">Hata</p><p>{globalError}</p></div>}
                       {globalSuccess && <div className="mt-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md"><p className="font-bold">Başarılı</p><div>{globalSuccess}</div></div>}
                  </div>

                  <div className="pt-4">
                      <StagingArea 
                          companies={stagedCompanies}
                          onArchiveAll={handleArchiveAllStaged}
                          onDelete={handleDeleteStagedCompany}
                          onDeleteAll={handleDeleteAllStaged}
                      />
                  </div>
                  
                  <div className="pt-4 space-y-4">
                     <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Arşivlenmiş Firmalar</h2>
                     <Filters 
                      filters={filters} 
                      onFilterChange={handleFilterChange} 
                      allCompanies={allCompanies}
                     />
                  </div>

                  <div className="pt-4">
                    <CompanyGroupList
                      companyGroups={filteredCompanyGroups}
                      onDelete={handleDeleteCompany}
                      onStatusChange={handleStatusChange}
                      onDeleteGroup={handleDeleteGroup}
                    />
                  </div>
              </div>
          );
      };

      const Overview = ({ companies }) => {
           const stats = useMemo(() => {
               const cities = {};
               const sectors = {};
               companies.forEach(c => {
                   const city = c.city ? c.city.trim() : 'Belirtilmemiş';
                   cities[city] = (cities[city] || 0) + 1;
                   const sector = c.sector ? c.sector.trim() : 'Belirtilmemiş';
                   sectors[sector] = (sectors[sector] || 0) + 1;
               });
               const sortAndSlice = (obj) => Object.entries(obj).sort(([,a], [,b]) => b - a).slice(0, 5);
               return { total: companies.length, topCities: sortAndSlice(cities), topSectors: sortAndSlice(sectors) };
           }, [companies]);
    
           return (
               <div className="bg-sky-50 dark:bg-sky-900/20 p-6 rounded-xl border border-sky-100 dark:border-sky-800 mb-8">
                   <div className="flex items-center gap-2 mb-4">
                       <ChartPieIcon className="w-6 h-6 text-sky-600 dark:text-sky-400" />
                       <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">Genel Bakış</h2>
                   </div>
                   <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                       <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex flex-col items-center justify-center text-center">
                           <span className="text-gray-500 dark:text-gray-400 text-sm font-medium uppercase tracking-wider">Toplam Firma</span>
                           <span className="text-5xl font-extrabold text-sky-600 dark:text-sky-400 mt-2">{stats.total}</span>
                       </div>
                       <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                           <h3 className="text-gray-700 dark:text-gray-200 font-semibold mb-3 border-b pb-2 border-gray-100 dark:border-gray-700">Şehir Dağılımı (Top 5)</h3>
                           <div className="space-y-2">{stats.topCities.map(([name, count]) => (<div key={name} className="flex justify-between items-center text-sm"><span className="text-gray-600 dark:text-gray-300 truncate pr-2">{name}</span><span className="font-bold text-gray-800 dark:text-white bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded-full text-xs">{count}</span></div>))}</div>
                       </div>
                       <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                           <h3 className="text-gray-700 dark:text-gray-200 font-semibold mb-3 border-b pb-2 border-gray-100 dark:border-gray-700">Sektör Dağılımı (Top 5)</h3>
                           <div className="space-y-2">{stats.topSectors.map(([name, count]) => (<div key={name} className="flex justify-between items-center text-sm"><span className="text-gray-600 dark:text-gray-300 truncate pr-2">{name}</span><span className="font-bold text-gray-800 dark:text-white bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded-full text-xs">{count}</span></div>))}</div>
                       </div>
                   </div>
               </div>
           );
       };

      const AnalyticsPage = ({ allCompanies, onDelete, onStatusChange }) => {
        return (
             <div className="space-y-8">
                <Overview companies={allCompanies} />
                <div className="bg-white dark:bg-gray-800 p-10 rounded-xl shadow-lg text-center">
                    <h2 className="text-xl font-bold dark:text-white">Detaylı Analiz</h2>
                    <p className="text-gray-500 mt-2">Bu bölümde arşivdeki tüm verileri detaylı filtreleyip inceleyebilirsiniz. (Yukarıdaki Genel Bakış özet verileri içerir.)</p>
                </div>
            </div>
        )
      };

      // --- WHATSAPP PRO COMPONENT ---
      
      const WhatsAppProPage = ({ allCompanies, companyGroups }) => {
        const [proContacts, setProContacts] = useState([]);
        const [activeTab, setActiveTab] = useState(1); // 1-5 Menu
        const [fileStats, setFileStats] = useState({ pdf: 0, img: 0, link: 0 });
        const [globalAttachment, setGlobalAttachment] = useState(null); // { type: 'pdf'|'img', url: string, name: string }
        const [btnFilter, setBtnFilter] = useState(''); // New: Search filter for buttons
        
        // Persistent States for Blacklist & History
        const [blacklist, setBlacklist] = usePersistentState('waProBlacklist', []); // Array of phone strings (normalized 90...)
        const [sentHistory, setSentHistory] = usePersistentState('waProSentHistory', {}); // { phoneNumber: [ {date: isoStr, template: short/med/long, hash: str} ] }

        // Active Filters State for Toggle Logic
        const [activeFilters, setActiveFilters] = useState({
            sectors: new Set(),
            cities: new Set()
        });

        // Computed unique values from Archive for Filters
        const archiveUniqueCities = useMemo(() => [...new Set(allCompanies.map(c => c.city).filter(Boolean))].sort(), [allCompanies]);
        const archiveUniqueSectors = useMemo(() => [...new Set(allCompanies.map(c => c.sector).filter(Boolean))].sort(), [allCompanies]);

        // Stats
        const stats = useMemo(() => {
            const sectors = new Set();
            const cities = new Set();
            let mobileCount = 0;
            let fixedCount = 0;
            
            proContacts.forEach(c => {
                if(c.sector) sectors.add(c.sector);
                if(c.city) cities.add(c.city);
                if(c.phone) {
                     if(c.phone.startsWith('905') || c.phone.startsWith('05')) mobileCount++;
                     else fixedCount++; // Assuming normalized numbers are basically valid
                }
            });

            return {
                total: proContacts.length,
                mobile: mobileCount,
                fixed: fixedCount,
                sectorCount: sectors.size,
                cityCount: cities.size,
                ...fileStats
            };
        }, [proContacts, fileStats]);

        // Phone Normalizer (Updated for Landlines)
        const normalizePhonePro = (raw) => {
            if(!raw) return null;
            let clean = raw.toString().replace(/\D/g, '');
            
            // Mobile: 0555... -> 90555...
            if(clean.length === 11 && clean.startsWith('05')) return '9' + clean;
            if(clean.length === 10 && clean.startsWith('5')) return '90' + clean;
            
            // Fixed: 0212... -> 90212... (starts with 02, 03, 04...)
            if(clean.length === 11 && clean.startsWith('0') && !clean.startsWith('05')) return '9' + clean;
            if(clean.length === 10 && !clean.startsWith('5')) return '90' + clean; // Assumes TR landline w/o leading 0

            // Already 90...
            if(clean.length === 12 && clean.startsWith('90')) return clean;
            
            return null;
        };
        
        const isBlacklisted = (phone) => blacklist.includes(phone);

        const handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const fileType = file.name.split('.').pop().toLowerCase();
            
            // 1. Excel / CSV Parsing
            if (['csv', 'xlsx', 'xls'].includes(fileType)) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = evt.target.result;
                    let workbook;
                    if (fileType === 'csv') {
                         workbook = window.XLSX.read(data, { type: 'binary' });
                    } else {
                         workbook = window.XLSX.read(data, { type: 'binary' });
                    }
                    
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = window.XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Array of arrays
                    
                    // Header mapping logic (heuristic)
                    const headers = json[0].map(h => h.toLowerCase());
                    const nameIdx = headers.findIndex(h => h.includes('isim') || h.includes('ad') || h.includes('name'));
                    const phoneIdx = headers.findIndex(h => h.includes('tel') || h.includes('phone') || h.includes('gsm'));
                    const cityIdx = headers.findIndex(h => h.includes('şehir') || h.includes('il') || h.includes('city'));
                    const sectorIdx = headers.findIndex(h => h.includes('sektör') || h.includes('sector'));
                    const companyIdx = headers.findIndex(h => h.includes('şirket') || h.includes('firma') || h.includes('company'));

                    const newContacts = [];
                    const seenPhones = new Set();
                    let blockedCount = 0;

                    // Skip header, start from 1
                    for(let i=1; i<json.length; i++) {
                        const row = json[i];
                        const rawPhone = row[phoneIdx];
                        const normPhone = normalizePhonePro(rawPhone);
                        
                        if (normPhone && !seenPhones.has(normPhone)) {
                            if (isBlacklisted(normPhone)) {
                                blockedCount++;
                                continue;
                            }
                            seenPhones.add(normPhone);
                            newContacts.push({
                                id: Date.now() + i,
                                name: row[nameIdx] || 'İsimsiz',
                                company: row[companyIdx] || 'Belirtilmemiş',
                                city: row[cityIdx] || 'Belirtilmemiş',
                                sector: row[sectorIdx] || 'Belirtilmemiş',
                                phone: normPhone,
                                group: 'Genel',
                                link: '',
                                fileType: null,
                                fileUrl: null,
                                source: 'manual-upload'
                            });
                        }
                    }
                    setProContacts(prev => [...prev, ...newContacts]);
                    let msg = `${newContacts.length} kişi eklendi.`;
                    if(blockedCount > 0) msg += ` (NOT: ${blockedCount} kişi Kara Listede olduğu için eklenmedi)`;
                    alert(msg);
                };
                reader.readAsBinaryString(file);
            } 
            // 2. Image / PDF Handling
            else if (['jpg', 'jpeg', 'png', 'pdf'].includes(fileType)) {
                 const url = URL.createObjectURL(file);
                 setGlobalAttachment({
                     type: fileType === 'pdf' ? 'pdf' : 'img',
                     url: url,
                     name: file.name
                 });
                 
                 // Update stats
                 setFileStats(prev => ({
                     ...prev,
                     [fileType === 'pdf' ? 'pdf' : 'img']: prev[fileType === 'pdf' ? 'pdf' : 'img'] + 1
                 }));
                 
                 alert(`Dosya yüklendi: ${file.name}. Gönderim sırasında 'Dosya' değişkeni bu dosyayı işaret edecek.`);
            }
        };

        const exportCleanList = () => {
            const ws = window.XLSX.utils.json_to_sheet(proContacts);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, "Temiz Liste");
            window.XLSX.writeFile(wb, "temiz_listem.xlsx");
        };
        
        // --- ARCHIVE INTEGRATION FUNCTIONS (TOGGLE LOGIC) ---
        
        const handleToggle = (type, value) => {
            const sourceKey = `${type}:${value}`;
            let isCurrentlyActive = false;
            
            if (type === 'sector') isCurrentlyActive = activeFilters.sectors.has(value);
            if (type === 'city') isCurrentlyActive = activeFilters.cities.has(value);

            // Update UI State
            setActiveFilters(prev => {
                const newFilters = { ...prev };
                if (type === 'sector') {
                    const newSet = new Set(prev.sectors);
                    if(isCurrentlyActive) newSet.delete(value); else newSet.add(value);
                    newFilters.sectors = newSet;
                }
                if (type === 'city') {
                    const newSet = new Set(prev.cities);
                    if(isCurrentlyActive) newSet.delete(value); else newSet.add(value);
                    newFilters.cities = newSet;
                }
                return newFilters;
            });

            // Update List Logic
            if (isCurrentlyActive) {
                // REMOVE: Filter out any contact that was added specifically by this source
                setProContacts(prev => prev.filter(c => c.source !== sourceKey));
            } else {
                // ADD: Find valid contacts and add them if not duplicate
                let candidates = [];
                if (type === 'sector') candidates = allCompanies.filter(c => c.sector === value);
                if (type === 'city') candidates = allCompanies.filter(c => c.city === value);

                const newContacts = [];
                // We check existing phones in current list to prevent duplicates
                const currentPhones = new Set(proContacts.map(c => c.phone));
                
                candidates.forEach(c => {
                    const normPhone = normalizePhonePro(c.phone);
                    // CHECK: Is Valid AND Is Mobile (905...)
                    const isMobile = normPhone && normPhone.startsWith('905');

                    // Only add if phone is valid Mobile and NOT already in the list
                    if (isMobile && !currentPhones.has(normPhone)) {
                        if (isBlacklisted(normPhone)) return; // Skip Blocked
                        
                        currentPhones.add(normPhone); // update local check set
                        newContacts.push({
                            id: `auto-${sourceKey}-${c.id}-${Date.now()}`,
                            name: c.name,
                            company: c.name,
                            city: c.city || 'Arşiv',
                            sector: c.sector || 'Genel',
                            phone: normPhone,
                            group: `${type === 'city' ? 'Şehir' : 'Sektör'}: ${value}`,
                            link: '', fileType: null, fileUrl: null,
                            source: sourceKey // TAG this contact so we can remove it later
                        });
                    }
                });

                if (newContacts.length > 0) {
                    setProContacts(prev => [...prev, ...newContacts]);
                }
            }
        };
        
        const importFromArchive = (filterType = 'mobile') => {
             const newContacts = [];
             const seenPhones = new Set(proContacts.map(c => c.phone));
             let blockedCount = 0;
             
             allCompanies.forEach(c => {
                 const normPhone = normalizePhonePro(c.phone);
                 if(normPhone && !seenPhones.has(normPhone)) {
                     // Check type
                     const isMobile = normPhone.startsWith('905');
                     if(filterType === 'mobile' && !isMobile) return;
                     if(filterType === 'fixed' && isMobile) return;
                     
                     if (isBlacklisted(normPhone)) {
                         blockedCount++;
                         return;
                     }

                     seenPhones.add(normPhone);
                     newContacts.push({
                         id: `archive-${c.id}`,
                         name: c.name,
                         company: c.name,
                         city: c.city || 'Arşiv',
                         sector: c.sector || 'Genel',
                         phone: normPhone,
                         group: `${c.city} - ${c.sector}`,
                         link: '',
                         fileType: null,
                         fileUrl: null,
                         source: 'mass-import'
                     });
                 }
             });
             
             let msg = "";
             if(newContacts.length > 0) {
                 setProContacts(prev => [...prev, ...newContacts]);
                 msg = `${newContacts.length} kişi (${filterType === 'mobile' ? 'Mobil' : 'Sabit'}) eklendi.`;
             } else {
                 msg = "Kriterlere uygun yeni numara bulunamadı.";
             }
             if(blockedCount > 0) msg += `\n(Ayrıca ${blockedCount} numara Kara Listede olduğu için atlandı.)`;
             alert(msg);
        };

        // --- SUB-VIEWS ---
        
        const StatCard = ({ label, value, sub }) => (
            <div className="bg-slate-800 p-4 rounded-lg text-white border border-slate-700">
                <div className="text-2xl font-bold text-sky-400">{value}</div>
                <div className="text-sm font-medium">{label}</div>
                {sub && <div className="text-xs text-slate-400 mt-1">{sub}</div>}
            </div>
        );

        const MenuButton = ({ id, label, onClick, active }) => (
             <button 
                onClick={onClick}
                className={`w-full text-left px-4 py-3 rounded-lg font-medium transition-all ${active ? 'bg-sky-600 text-white shadow-lg shadow-sky-900/50' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'}`}
             >
                {label}
             </button>
        );
        
        // --- Search List Builder Component (Tab 5) ---
        const SearchListBuilder = () => {
             const [filters, setFilters] = useState({ city: '', sector: '', lineType: 'all' }); // lineType: all, mobile, fixed
             const [results, setResults] = useState([]);
             
             const handleSearch = () => {
                 let filtered = allCompanies;
                 if(filters.city) filtered = filtered.filter(c => c.city === filters.city);
                 if(filters.sector) filtered = filtered.filter(c => c.sector === filters.sector);
                 
                 // Filter by line type after normalization
                 if(filters.lineType !== 'all') {
                     filtered = filtered.filter(c => {
                         const norm = normalizePhonePro(c.phone);
                         if(!norm) return false;
                         const isMobile = norm.startsWith('905');
                         return filters.lineType === 'mobile' ? isMobile : !isMobile;
                     });
                 }
                 
                 setResults(filtered);
             };

             const addResultsToMainList = () => {
                 const newContacts = [];
                 const seenPhones = new Set(proContacts.map(c => c.phone));
                 let blockedCount = 0;
                 
                 results.forEach(c => {
                    const normPhone = normalizePhonePro(c.phone);
                     if(normPhone && !seenPhones.has(normPhone)) {
                         if (isBlacklisted(normPhone)) {
                             blockedCount++;
                             return;
                         }
                         seenPhones.add(normPhone);
                         newContacts.push({
                             id: `search-${c.id}-${Date.now()}`,
                             name: c.name,
                             company: c.name,
                             city: c.city,
                             sector: c.sector,
                             phone: normPhone,
                             group: 'Arama Listesi',
                             link: '', fileType: null, fileUrl: null,
                             source: 'search-builder'
                         });
                     }
                 });
                 if(newContacts.length > 0) {
                     setProContacts(prev => [...prev, ...newContacts]);
                     let msg = `${newContacts.length} kişi ana listeye eklendi.`;
                     if(blockedCount > 0) msg += ` (${blockedCount} kişi engelli)`;
                     alert(msg);
                 } else {
                     alert("Seçilen kişiler zaten listede veya telefonları geçersiz.");
                 }
             };

             return (
                 <div className="space-y-6">
                     <div className="bg-slate-800 p-6 rounded-lg border border-slate-700">
                         <h3 className="text-xl font-bold text-white mb-4">Arama Listesi Oluşturucu</h3>
                         <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                             <div>
                                 <label className="block text-slate-400 text-sm mb-1">Şehir</label>
                                 <select 
                                    className="w-full bg-slate-700 text-white p-2 rounded border border-slate-600"
                                    value={filters.city} onChange={e => setFilters({...filters, city: e.target.value})}
                                 >
                                     <option value="">Tümü</option>
                                     {archiveUniqueCities.map(c => <option key={c} value={c}>{c}</option>)}
                                 </select>
                             </div>
                             <div>
                                 <label className="block text-slate-400 text-sm mb-1">Sektör</label>
                                 <select 
                                    className="w-full bg-slate-700 text-white p-2 rounded border border-slate-600"
                                    value={filters.sector} onChange={e => setFilters({...filters, sector: e.target.value})}
                                 >
                                     <option value="">Tümü</option>
                                     {archiveUniqueSectors.map(s => <option key={s} value={s}>{s}</option>)}
                                 </select>
                             </div>
                              <div>
                                 <label className="block text-slate-400 text-sm mb-1">Hat Türü</label>
                                 <select 
                                    className="w-full bg-slate-700 text-white p-2 rounded border border-slate-600"
                                    value={filters.lineType} onChange={e => setFilters({...filters, lineType: e.target.value})}
                                 >
                                     <option value="all">Tümü (Mobil + Sabit)</option>
                                     <option value="mobile">Sadece Mobil (WhatsApp)</option>
                                     <option value="fixed">Sadece Sabit Hat</option>
                                 </select>
                             </div>
                         </div>
                         <button onClick={handleSearch} className="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 rounded transition-colors">
                             Listeyi Getir
                         </button>
                     </div>
                     
                     {results.length > 0 && (
                         <div className="bg-white rounded-lg p-4 shadow-lg">
                             <div className="flex justify-between items-center mb-4">
                                <h4 className="font-bold text-slate-800">Bulunan Kayıtlar ({results.length})</h4>
                                <button onClick={addResultsToMainList} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Hepsini Ana Listeye Ekle
                                </button>
                             </div>
                             <div className="max-h-96 overflow-y-auto border border-slate-200 rounded">
                                 <table className="w-full text-sm text-left">
                                     <thead className="bg-slate-100 text-slate-700 sticky top-0">
                                         <tr>
                                             <th className="px-4 py-2">Firma</th>
                                             <th className="px-4 py-2">Telefon</th>
                                             <th className="px-4 py-2">Şehir/Sektör</th>
                                             <th className="px-4 py-2">Durum</th>
                                         </tr>
                                     </thead>
                                     <tbody className="divide-y divide-slate-100">
                                         {results.map(r => (
                                             <tr key={r.id}>
                                                 <td className="px-4 py-2 text-slate-800 font-medium">{r.name}</td>
                                                 <td className="px-4 py-2 font-mono">
                                                     <a href={`tel:+${r.phone}`} className="text-sky-600 hover:text-sky-800 hover:underline">
                                                         {r.phone}
                                                     </a>
                                                 </td>
                                                 <td className="px-4 py-2 text-slate-500">{r.city} / {r.sector}</td>
                                                 <td className="px-4 py-2">
                                                     <span className="text-xs px-2 py-0.5 rounded bg-slate-200 text-slate-600">{r.status}</span>
                                                 </td>
                                             </tr>
                                         ))}
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                     )}
                 </div>
             );
        };
        
        // --- Blacklist Manager (Tab 6) ---
        const BlacklistManager = () => {
             const [inputPhone, setInputPhone] = useState('');

             const addBlacklist = (e) => {
                 e.preventDefault();
                 const norm = normalizePhonePro(inputPhone);
                 if(norm) {
                     if(!blacklist.includes(norm)) {
                         setBlacklist(prev => [norm, ...prev]);
                         setInputPhone('');
                     } else {
                         alert("Bu numara zaten kara listede.");
                     }
                 } else {
                     alert("Geçersiz telefon formatı.");
                 }
             };

             const removeBlacklist = (phone) => {
                 setBlacklist(prev => prev.filter(p => p !== phone));
             };

             const importFromArchiveAgreed = () => {
                 const agreedCompanies = allCompanies.filter(c => 
                     c.status === 'Arandı - Anlaşıldı' || c.status === 'Arandı - İlgilenmiyor'
                 );
                 if (agreedCompanies.length === 0) return alert("Arşivde 'Anlaşıldı' veya 'İlgilenmiyor' statüsünde firma bulunamadı.");

                 let addedCount = 0;
                 setBlacklist(prev => {
                     const newSet = new Set(prev);
                     agreedCompanies.forEach(c => {
                         const norm = normalizePhonePro(c.phone);
                         if (norm) {
                             if (!newSet.has(norm)) {
                                 newSet.add(norm);
                                 addedCount++;
                             }
                         }
                     });
                     return Array.from(newSet);
                 });
                 alert(`${addedCount} adet numara arşivden kara listeye eklendi.`);
             };

             return (
                 <div className="space-y-6">
                     <div className="bg-slate-800 p-6 rounded-lg border border-slate-700">
                         <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                             <NoSymbolIcon className="w-6 h-6 text-red-500"/>
                             Engellenen Numaralar (Kara Liste)
                         </h3>
                         <p className="text-slate-400 mb-6">
                             Buraya eklenen numaralara <strong>ASLA</strong> Bot tarafından mesaj gönderilmez. Manuel veya otomatik listeye eklenseler bile gönderim sırasında atlanırlar.
                         </p>

                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <form onSubmit={addBlacklist} className="bg-slate-700 p-4 rounded-lg">
                                 <label className="block text-white text-sm font-bold mb-2">Manuel Numara Ekle</label>
                                 <div className="flex gap-2">
                                     <input 
                                        type="text" 
                                        value={inputPhone} 
                                        onChange={e => setInputPhone(e.target.value)} 
                                        placeholder="5XX..." 
                                        className="flex-1 p-2 rounded bg-slate-600 text-white border border-slate-500"
                                     />
                                     <button type="submit" className="bg-red-600 text-white px-4 rounded hover:bg-red-700 font-bold">Engelle</button>
                                 </div>
                             </form>

                             <div className="bg-slate-700 p-4 rounded-lg flex flex-col justify-center">
                                 <label className="block text-white text-sm font-bold mb-2">Arşivden Otomatik Çek</label>
                                 <button onClick={importFromArchiveAgreed} className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 font-bold text-sm">
                                     "Anlaşıldı" ve "İlgilenmiyor" Olanları Engelle
                                 </button>
                                 <p className="text-xs text-slate-400 mt-2">Mevcut müşterilere tekrar mesaj gitmemesi için önerilir.</p>
                             </div>
                         </div>

                         <div className="bg-white rounded-lg p-4 max-h-96 overflow-y-auto">
                             <h4 className="font-bold text-slate-800 mb-2">Engelli Listesi ({blacklist.length})</h4>
                             <table className="w-full text-sm text-left">
                                 <thead className="bg-slate-100 text-slate-700 sticky top-0">
                                     <tr>
                                         <th className="px-4 py-2">Telefon</th>
                                         <th className="px-4 py-2">İşlem</th>
                                     </tr>
                                 </thead>
                                 <tbody className="divide-y divide-slate-100">
                                     {blacklist.map(phone => (
                                         <tr key={phone}>
                                             <td className="px-4 py-2 font-mono text-slate-600">{phone}</td>
                                             <td className="px-4 py-2">
                                                 <button onClick={() => removeBlacklist(phone)} className="text-red-500 hover:underline">Engeli Kaldır</button>
                                             </td>
                                         </tr>
                                     ))}
                                     {blacklist.length === 0 && <tr><td colSpan="2" className="p-4 text-center text-slate-500">Kara liste boş.</td></tr>}
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             );
        };

        const SenderBot = () => {
            const [templateType, setTemplateType] = useState('short'); // short, medium, long
            const defaultTemplates = {
                short: "Merhaba {isim}, {şirket} için matbaa ve baskı ihtiyaçlarınızda yanınızdayız. Fiyatlarımızı incelemek isterseniz: {link} {dosya}",
                medium: "Selamlar {isim}, {sektör} sektöründeki firmanız {şirket} için özel promosyon ve baskı çözümleri hazırladık. Katalog ve numunelerimiz için linke göz atabilirsiniz: {link} {dosya}",
                long: "Sayın {isim}, iyi çalışmalar dileriz. {şehir} bölgesinde hizmet veren matbaamız, {şirket} gibi kurumsal firmalara özel etiket, kutu ve promosyon ürünleri üretmektedir. Sizin için hazırladığımız özel teklif dosyasını ekte sunuyoruz. Detaylı bilgi için: {link} {dosya}"
            };
            
            // Persistent Template Memory
            const [savedTemplates, setSavedTemplates] = usePersistentState('botTemplates', defaultTemplates);

            const [delayMin, setDelayMin] = useState(12);
            const [delayMax, setDelayMax] = useState(20);
            const [isSending, setIsSending] = useState(false);
            const [progress, setProgress] = useState(0);
            const [logs, setLogs] = useState([]);
            
            const handleTemplateEdit = (e) => {
                setSavedTemplates(prev => ({ ...prev, [templateType]: e.target.value }));
            };
            
            // Hash function for duplicate checking
            const generateMessageHash = (text) => {
                let hash = 0, i, chr;
                if (text.length === 0) return hash;
                for (i = 0; i < text.length; i++) {
                  chr = text.charCodeAt(i);
                  hash = ((hash << 5) - hash) + chr;
                  hash |= 0; 
                }
                return hash.toString();
            };

            const generateMessage = (contact) => {
                let msg = savedTemplates[templateType];
                msg = msg.replace(/{isim}/g, contact.name || '');
                msg = msg.replace(/{şirket}/g, contact.company || '');
                msg = msg.replace(/{şehir}/g, contact.city || '');
                msg = msg.replace(/{sektör}/g, contact.sector || '');
                msg = msg.replace(/{link}/g, contact.link || 'https://www.websiteniz.com'); // Fallback link
                
                let fileNote = "";
                if(msg.includes('{dosya}') && globalAttachment) {
                    fileNote = `(Dosya Eki: ${globalAttachment.name} - Lütfen ayrıca gönderin)`;
                    msg = msg.replace(/{dosya}/g, ""); // Remove the placeholder from URL
                } else {
                     msg = msg.replace(/{dosya}/g, "");
                }
                
                return { text: msg, note: fileNote };
            };

            const startSending = async () => {
                if(proContacts.length === 0) return alert("Liste boş!");
                
                // Filter out Fixed Lines
                const mobileContacts = proContacts.filter(c => c.phone.startsWith('905'));
                const fixedCount = proContacts.length - mobileContacts.length;

                if(fixedCount > 0) {
                     if(!window.confirm(`Listede ${fixedCount} adet Sabit Hat bulundu. Bunlara WhatsApp mesajı atılamaz ve atlanacaktır. Sadece ${mobileContacts.length} adet Mobil numaraya gönderim yapılsın mı?`)) return;
                }
                
                // --- DUPLICATE CHECK LOGIC ---
                const contactsToSend = [];
                const duplicates = [];
                
                for(const contact of mobileContacts) {
                     const { text } = generateMessage(contact);
                     const hash = generateMessageHash(text);
                     const history = sentHistory[contact.phone] || [];
                     
                     // Check if this hash exists in history
                     const isDuplicate = history.some(h => h.hash === hash);
                     
                     if (isDuplicate) {
                         duplicates.push(contact);
                     } else {
                         contactsToSend.push(contact);
                     }
                }
                
                let finalQueue = contactsToSend;
                
                if (duplicates.length > 0) {
                    const proceed = window.confirm(`UYARI: ${duplicates.length} kişiye BU MESAJ daha önce gönderilmiş.\n\n"Tamam" derseniz bu kişilere tekrar gönderilir.\n"İptal" derseniz bu kişiler atlanır.`);
                    if (proceed) {
                        finalQueue = [...contactsToSend, ...duplicates];
                    }
                }
                
                if (finalQueue.length === 0) return alert("Gönderilecek kimse kalmadı.");
                
                // --- START ---

                setIsSending(true);
                setProgress(0);
                setLogs([]);
                
                for(let i=0; i < finalQueue.length; i++) {
                    if(!isSending && i > 0) break; // Stop mechanism logic would need a ref, simplified here
                    
                    const contact = finalQueue[i];
                    
                    // Final Blacklist Check (Safety Net)
                    if(isBlacklisted(contact.phone)) {
                        setLogs(prev => [...prev, { time: new Date().toLocaleTimeString(), name: contact.name, phone: contact.phone, status: "Kara Listede (Atlandı)" }]);
                        continue;
                    }

                    const { text } = generateMessage(contact);
                    const hash = generateMessageHash(text);
                    const url = `https://wa.me/${contact.phone}?text=${encodeURIComponent(text)}`;
                    
                    // Open window
                    const win = window.open(url, '_blank');
                    
                    // Log & History Save
                    const status = win ? "Gönderildi (Pencere Açıldı)" : "Engellendi (Popup Blocker)";
                    
                    if (win) {
                        // Add to history
                        setSentHistory(prev => {
                            const prevList = prev[contact.phone] || [];
                            return { ...prev, [contact.phone]: [...prevList, { date: new Date().toISOString(), template: templateType, hash: hash }] };
                        });
                    }

                    setLogs(prev => [...prev, { time: new Date().toLocaleTimeString(), name: contact.name, phone: contact.phone, status }]);
                    
                    // Progress
                    setProgress(Math.round(((i + 1) / finalQueue.length) * 100));

                    // Delay
                    const delay = Math.floor(Math.random() * (delayMax - delayMin + 1) + delayMin) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
                setIsSending(false);
                alert("Gönderim kuyruğu tamamlandı.");
            };

            return (
                <div className="space-y-6">
                    {/* Summary Box */}
                    <div className="bg-sky-900/40 border border-sky-500/30 p-4 rounded-xl">
                        <h4 className="text-white font-bold mb-3 flex items-center gap-2">
                             <ListBulletIcon className="w-5 h-5 text-sky-400"/>
                             Gönderim Özeti
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                            <div className="bg-slate-800/50 p-2 rounded border border-slate-700">
                                <span className="block text-slate-400 text-xs">Seçili Şehirler</span>
                                <span className="text-white font-medium">{activeFilters.cities.size > 0 ? Array.from(activeFilters.cities).join(', ') : 'Seçim Yok'}</span>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded border border-slate-700">
                                <span className="block text-slate-400 text-xs">Seçili Sektörler</span>
                                <span className="text-white font-medium">{activeFilters.sectors.size > 0 ? Array.from(activeFilters.sectors).join(', ') : 'Seçim Yok'}</span>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded border border-slate-700">
                                <span className="block text-slate-400 text-xs">Manuel Dosyalar</span>
                                <span className="text-white font-medium">{fileStats.img + fileStats.pdf} Dosya Eklendi</span>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded border border-slate-700 col-span-1 md:col-span-2 lg:col-span-3">
                                <span className="block text-slate-400 text-xs">Toplam Gönderilecek Kişi</span>
                                <span className="text-green-400 font-bold text-lg">{proContacts.length} Kişi</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                             <RocketLaunchIcon className="w-6 h-6 text-sky-400" />
                             Mesaj Botu Ayarları
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label className="block text-slate-300 text-sm mb-2">Şablon Seçimi</label>
                                <div className="flex gap-2">
                                    <button onClick={() => setTemplateType('short')} className={`px-3 py-1 rounded text-sm ${templateType==='short' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300'}`}>Kısa</button>
                                    <button onClick={() => setTemplateType('medium')} className={`px-3 py-1 rounded text-sm ${templateType==='medium' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300'}`}>Orta</button>
                                    <button onClick={() => setTemplateType('long')} className={`px-3 py-1 rounded text-sm ${templateType==='long' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300'}`}>Uzun</button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-slate-300 text-sm mb-2">Gecikme Süresi (Saniye)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" value={delayMin} onChange={e=>setDelayMin(Number(e.target.value))} className="w-16 bg-slate-700 border-none rounded text-white p-1" />
                                    <span className="text-slate-500">-</span>
                                    <input type="number" value={delayMax} onChange={e=>setDelayMax(Number(e.target.value))} className="w-16 bg-slate-700 border-none rounded text-white p-1" />
                                </div>
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="block text-slate-300 text-sm mb-2">Mesaj İçeriği (Otomatik Kaydedilir)</label>
                            <textarea 
                                value={savedTemplates[templateType]} 
                                onChange={handleTemplateEdit} 
                                className="w-full h-32 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-sky-500 outline-none font-mono text-sm"
                            />
                            <div className="text-xs text-slate-400 mt-2 flex flex-wrap gap-2">
                                <span>Değişkenler:</span>
                                <span className="bg-slate-900 px-1 rounded">{`{isim}`}</span>
                                <span className="bg-slate-900 px-1 rounded">{`{şirket}`}</span>
                                <span className="bg-slate-900 px-1 rounded">{`{şehir}`}</span>
                                <span className="bg-slate-900 px-1 rounded">{`{sektör}`}</span>
                                <span className="bg-slate-900 px-1 rounded">{`{link}`}</span>
                                <span className="bg-slate-900 px-1 rounded">{`{dosya}`}</span>
                            </div>
                        </div>
                        
                         {globalAttachment && (
                            <div className="mb-6 p-3 bg-slate-700/50 rounded-lg border border-sky-500/30 flex items-center gap-3">
                                <div className="p-2 bg-sky-900/50 rounded-lg text-sky-400">
                                   {globalAttachment.type === 'pdf' ? <DocumentTextIcon className="w-6 h-6"/> : <PhotoIcon className="w-6 h-6"/>}
                                </div>
                                <div>
                                    <div className="text-white text-sm font-medium">Ekli Dosya: {globalAttachment.name}</div>
                                    <div className="text-xs text-slate-400">Bu dosya mesaj ile birlikte gönderilmez, ancak ekranda hazır tutulur.</div>
                                </div>
                                {globalAttachment.type === 'img' && (
                                    <img src={globalAttachment.url} className="w-10 h-10 object-cover rounded ml-auto" />
                                )}
                            </div>
                        )}

                        <div className="flex gap-4">
                             <button 
                                onClick={startSending} 
                                disabled={isSending}
                                className={`flex-1 py-3 rounded-lg font-bold flex items-center justify-center gap-2 ${isSending ? 'bg-slate-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                            >
                                {isSending ? <SpinnerIcon className="w-5 h-5"/> : <PaperAirplaneIcon className="w-5 h-5" />}
                                {isSending ? 'Gönderim Sürüyor...' : 'Toplu Gönderimi Başlat'}
                             </button>
                             {isSending && (
                                 <button onClick={()=>window.location.reload()} className="bg-red-600 px-6 rounded-lg font-bold text-white">DURDUR</button>
                             )}
                        </div>
                    </div>
                    
                    {/* Progress & Logs */}
                    {isSending || logs.length > 0 ? (
                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                             <div className="mb-4">
                                <div className="flex justify-between text-sm text-slate-400 mb-1">
                                    <span>İlerleme</span>
                                    <span>{progress}%</span>
                                </div>
                                <div className="w-full bg-slate-700 rounded-full h-2.5">
                                    <div className="bg-sky-500 h-2.5 rounded-full transition-all duration-300" style={{ width: `${progress}%` }}></div>
                                </div>
                             </div>
                             
                             <div className="max-h-60 overflow-y-auto bg-slate-900 rounded p-2 text-xs font-mono text-slate-300">
                                {logs.map((log, idx) => (
                                    <div key={idx} className="border-b border-slate-800 py-1 flex justify-between">
                                        <span>[{log.time}] {log.name} ({log.phone})</span>
                                        <span className={log.status.includes('Engellendi') || log.status.includes('Kara') ? 'text-red-400' : 'text-green-400'}>{log.status}</span>
                                    </div>
                                ))}
                             </div>
                        </div>
                    ) : null}
                </div>
            );
        };
        
        const ContactTable = () => (
             <div className="overflow-x-auto bg-white dark:bg-slate-800 rounded-lg shadow border border-slate-200 dark:border-slate-700">
                <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                    <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                        <tr>
                            <th className="px-6 py-3">İsim</th>
                            <th className="px-6 py-3">Şirket</th>
                            <th className="px-6 py-3">Telefon (+90)</th>
                            <th className="px-6 py-3">Şehir / Sektör</th>
                            <th className="px-6 py-3">Grup / Hat</th>
                            <th className="px-6 py-3">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {proContacts.slice(0, 100).map((c) => {
                            const isMobile = c.phone.startsWith('905');
                            return (
                                <tr key={c.id} className="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                    <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">{c.name}</td>
                                    <td className="px-6 py-4">{c.company}</td>
                                    <td className="px-6 py-4 font-mono">
                                        <a href={`tel:+${c.phone}`} className="text-sky-600 hover:text-sky-800 hover:underline flex items-center gap-1">
                                            {c.phone}
                                        </a>
                                    </td>
                                    <td className="px-6 py-4">{c.city} / {c.sector}</td>
                                    <td className="px-6 py-4">
                                        <div className="flex flex-col gap-1">
                                            <span className="bg-slate-100 text-slate-800 text-xs font-medium px-2 py-0.5 rounded dark:bg-slate-700 dark:text-slate-300 w-fit">{c.group}</span>
                                            <span className={`text-xs font-bold px-2 py-0.5 rounded w-fit ${isMobile ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>
                                                {isMobile ? 'Mobil' : 'Sabit Hat'}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 flex items-center gap-3">
                                        {isMobile ? (
                                             <a href={`https://wa.me/${c.phone}`} target="_blank" className="text-green-500 hover:text-green-600" title="WhatsApp Aç">
                                                 <WhatsAppIcon className="w-5 h-5"/>
                                             </a>
                                        ) : (
                                            <a href={`tel:+${c.phone}`} className="text-sky-500 hover:text-sky-600 font-bold text-xs border border-sky-500 px-2 py-1 rounded" title="Ara">
                                                 ARA (TEL)
                                             </a>
                                        )}
                                        <button className="text-red-500 hover:underline text-xs" onClick={() => setProContacts(proContacts.filter(x=>x.id!==c.id))}>Sil</button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
                {proContacts.length > 100 && <div className="p-4 text-center text-slate-500 italic">...ve {proContacts.length - 100} kişi daha.</div>}
            </div>
        );

        return (
            <div className="bg-slate-900 min-h-screen text-slate-200 p-6 -m-4 sm:-m-6 lg:-m-8 rounded-none sm:rounded-none lg:rounded-none">
                 <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-slate-700 pb-6">
                     <div>
                         <h1 className="text-3xl font-bold text-white flex items-center gap-2">
                             <RocketLaunchIcon className="w-8 h-8 text-sky-500" />
                             WhatsApp PRO <span className="text-sm bg-sky-600 text-white px-2 py-1 rounded ml-2">Matbaa Sürümü</span>
                         </h1>
                         <p className="text-slate-400 mt-1">Gelişmiş toplu mesaj ve müşteri yönetim asistanı.</p>
                     </div>
                 </div>

                 {/* Stats Grid */}
                 <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                     <StatCard label="Toplam Müşteri" value={stats.total} />
                     <StatCard label="WhatsApp No" value={stats.mobile} sub="Geçerli +90" />
                     <StatCard label="Sabit Hat" value={stats.fixed} sub="Sabit Numaralar" />
                     <StatCard label="Sektör" value={stats.sectorCount} />
                     <StatCard label="Şehir" value={stats.cityCount} />
                     <StatCard label="Dosya" value={stats.pdf + stats.img} />
                 </div>

                 <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                     {/* Left Menu */}
                     <div className="lg:col-span-1 space-y-2">
                         <MenuButton id={1} label="[1] Numaraları Bul" active={activeTab===1} onClick={()=>setActiveTab(1)} />
                         <MenuButton id={2} label="[2] Sektöre Göre Filtrele" active={activeTab===2} onClick={()=>setActiveTab(2)} />
                         <MenuButton id={3} label="[3] Şehre Göre Filtrele" active={activeTab===3} onClick={()=>setActiveTab(3)} />
                         <MenuButton id={4} label="[4] Toplu Reklam Gönder (Bot)" active={activeTab===4} onClick={()=>setActiveTab(4)} />
                         <MenuButton id={5} label="[5] Arama Listesi Hazırla" active={activeTab===5} onClick={()=>setActiveTab(5)} />
                         <MenuButton id={6} label="[6] Engellenenler (Kara Liste)" active={activeTab===6} onClick={()=>setActiveTab(6)} />
                     </div>

                     {/* Main Content Area */}
                     <div className="lg:col-span-3 bg-slate-800/50 rounded-xl p-1">
                         {activeTab === 4 ? (
                             <SenderBot />
                         ) : activeTab === 6 ? (
                             <BlacklistManager />
                         ) : activeTab === 1 ? (
                             <div className="bg-slate-800 p-6 rounded-lg text-center space-y-6">
                                 <div>
                                     <h3 className="text-xl font-bold text-white mb-2">WhatsApp Kullanıcılarını Bul</h3>
                                     <p className="text-slate-400 mb-4">Arşivdeki cep telefonlarını (05...) tarar ve listeye ekler.</p>
                                     <button onClick={() => importFromArchive('mobile')} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 mx-auto w-full sm:w-auto justify-center">
                                         <WhatsAppIcon className="w-6 h-6" />
                                         Mobil (WhatsApp) Olanları Getir
                                     </button>
                                 </div>
                                 <div className="border-t border-slate-700 pt-6">
                                     <h3 className="text-xl font-bold text-white mb-2">Sabit Hatları Bul</h3>
                                     <p className="text-slate-400 mb-4">Arşivdeki sabit numaraları (0212, 0312...) tarar ve listeye ekler.</p>
                                     <button onClick={() => importFromArchive('fixed')} className="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 mx-auto w-full sm:w-auto justify-center">
                                         <PhoneIcon className="w-6 h-6" />
                                         Sabit Hatları Getir
                                     </button>
                                 </div>
                                 <div className="border-t border-slate-700 pt-6">
                                     <button onClick={() => setProContacts([])} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg w-full sm:w-auto">
                                         Listeyi Temizle (Sıfırla)
                                     </button>
                                 </div>
                             </div>
                         ) : activeTab === 2 ? (
                             <div className="bg-slate-800 p-6 rounded-lg">
                                 <h3 className="text-xl font-bold text-white mb-1">Sektöre Göre Seç (Tıkla Ekle/Çıkar)</h3>
                                 <p className="text-xs text-slate-400 mb-4">WhatsApp için sadece Mobil (05...) numaralar eklenir.</p>
                                 
                                 <div className="flex flex-col sm:flex-row gap-3 mb-4">
                                     <input 
                                        type="text" 
                                        placeholder="Sektör ara..." 
                                        value={btnFilter} 
                                        onChange={e => setBtnFilter(e.target.value)}
                                        className="bg-slate-700 text-white px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-sky-500 w-full sm:w-1/2"
                                     />
                                     <div className="flex gap-2 w-full sm:w-1/2">
                                         <button onClick={() => setProContacts([])} className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold flex-1">
                                             Listeyi Temizle
                                         </button>
                                     </div>
                                 </div>

                                 <div className="flex flex-wrap gap-2 max-h-96 overflow-y-auto">
                                     {archiveUniqueSectors
                                         .filter(s => s.toLowerCase().includes(btnFilter.toLowerCase()))
                                         .map(s => (
                                         <button 
                                            key={s} 
                                            onClick={() => handleToggle('sector', s)} 
                                            className={`px-3 py-2 rounded-lg text-sm transition-all border ${activeFilters.sectors.has(s) ? 'bg-green-600 border-green-500 text-white shadow-lg scale-105' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'}`}
                                        >
                                             {s}
                                             {activeFilters.sectors.has(s) && <CheckCircleIcon className="w-4 h-4 inline ml-2"/>}
                                         </button>
                                     ))}
                                     {archiveUniqueSectors.length === 0 && <p className="text-slate-500">Arşivde sektör bilgisi bulunamadı.</p>}
                                 </div>
                             </div>
                         ) : activeTab === 3 ? (
                             <div className="bg-slate-800 p-6 rounded-lg">
                                 <h3 className="text-xl font-bold text-white mb-1">Şehre Göre Seç (Tıkla Ekle/Çıkar)</h3>
                                 <p className="text-xs text-slate-400 mb-4">WhatsApp için sadece Mobil (05...) numaralar eklenir.</p>

                                 <div className="flex flex-col sm:flex-row gap-3 mb-4">
                                     <input 
                                        type="text" 
                                        placeholder="Şehir ara..." 
                                        value={btnFilter} 
                                        onChange={e => setBtnFilter(e.target.value)}
                                        className="bg-slate-700 text-white px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-sky-500 w-full sm:w-1/2"
                                     />
                                     <div className="flex gap-2 w-full sm:w-1/2">
                                         <button onClick={() => setProContacts([])} className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold flex-1">
                                             Listeyi Temizle
                                         </button>
                                     </div>
                                 </div>

                                 <div className="flex flex-wrap gap-2 max-h-96 overflow-y-auto">
                                     {archiveUniqueCities
                                         .filter(c => c.toLowerCase().includes(btnFilter.toLowerCase()))
                                         .map(c => (
                                         <button 
                                            key={c} 
                                            onClick={() => handleToggle('city', c)} 
                                            className={`px-3 py-2 rounded-lg text-sm transition-all border ${activeFilters.cities.has(c) ? 'bg-green-600 border-green-500 text-white shadow-lg scale-105' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'}`}
                                        >
                                             {c}
                                             {activeFilters.cities.has(c) && <CheckCircleIcon className="w-4 h-4 inline ml-2"/>}
                                         </button>
                                     ))}
                                      {archiveUniqueCities.length === 0 && <p className="text-slate-500">Arşivde şehir bilgisi bulunamadı.</p>}
                                 </div>
                             </div>
                         ) : activeTab === 5 ? (
                             <SearchListBuilder />
                         ) : (
                             <div className="space-y-4">
                                 <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-center">
                                     <h3 className="font-bold text-white">Müşteri Listesi</h3>
                                     <div className="text-sm text-slate-400">
                                         {proContacts.length === 0 ? "Henüz veri yüklenmedi." : "Gönderim için hazırlanan liste:"}
                                     </div>
                                 </div>
                                 <ContactTable />
                             </div>
                         )}
                         
                         {/* Show Table Preview if not in Bot Mode, not in Search Builder, not in Blacklist */}
                         {activeTab !== 4 && activeTab !== 5 && activeTab !== 6 && (
                             <div className="mt-4 bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                                    <ListBulletIcon className="w-5 h-5 text-sky-500"/>
                                    Hazırlanan Gönderim Listesi ({proContacts.length} Kişi)
                                </h3>
                                {proContacts.length === 0 ? (
                                    <div className="p-8 text-center text-slate-500 border border-dashed border-slate-600 rounded">
                                        <p>Liste şu an boş. Yukarıdaki butonlara tıklayarak kişi ekleyin.</p>
                                    </div>
                                ) : (
                                    <ContactTable />
                                )}
                             </div>
                         )}
                     </div>
                 </div>
                 
                 {/* Embed/Preview Area for Global File */}
                 {globalAttachment && (
                     <div className="mt-8 bg-slate-800 p-6 rounded-xl border border-slate-700">
                         <h3 className="text-xl font-bold text-white mb-4">Dosya Önizleme</h3>
                         {globalAttachment.type === 'pdf' ? (
                             <embed src={globalAttachment.url} type="application/pdf" width="100%" height="600px" className="rounded-lg" />
                         ) : (
                             <img src={globalAttachment.url} alt="Uploaded" className="max-w-full h-auto rounded-lg mx-auto" style={{ maxHeight: '500px' }} />
                         )}
                     </div>
                 )}
            </div>
        );
      };

      // --- MAIN APP ---

      const App = () => {
        const [companyGroups, setCompanyGroups, saveStatus] = usePersistentState('companyGroups', {});
        const [stagedCompanies, setStagedCompanies] = useState([]);
        const [apiKey, setApiKey] = useState(null);
        const [loadingSource, setLoadingSource] = useState(null);
        const [globalError, setGlobalError] = useState(null);
        const [globalSuccess, setGlobalSuccess] = useState(null);
        
        const [filters, setFilters] = useState(() => {
            try { return JSON.parse(localStorage.getItem('companyFilters')) || { searchTerm: '', sector: '', city: '', district: '', status: '' }; } catch(e) { return { searchTerm: '', sector: '', city: '', district: '', status: '' }; }
        });
        const [targetArchive, setTargetArchive] = useState(() => {
            try { return JSON.parse(localStorage.getItem('targetArchive')) || { city: '', district: '', sector: '' }; } catch(e) { return { city: '', district: '', sector: '' }; }
        });
        
        const [activePage, setActivePage] = useState('management');
        
        // ... (Existing App logic for imports, state management, etc.)
        // Preserving existing logic...

        const isTargetArchiveValid = useMemo(() => Object.values(targetArchive).every(field => field.trim() !== ''), [targetArchive]);

        useEffect(() => { localStorage.setItem('companyFilters', JSON.stringify(filters)); }, [filters]);
        useEffect(() => { localStorage.setItem('targetArchive', JSON.stringify(targetArchive)); }, [targetArchive]);
        useEffect(() => { const savedApiKey = localStorage.getItem('geminiApiKey'); if (savedApiKey) setApiKey(savedApiKey); }, []);
        
        const allCompanies = useMemo(() => Object.values(companyGroups).flat(), [companyGroups]);
        
        const displaySuccess = (message) => { setGlobalSuccess(message); setTimeout(() => setGlobalSuccess(null), 6000); }
        const displayError = (message) => { setGlobalError(message); setTimeout(() => setGlobalError(null), 6000); }
        const handleFilterChange = (newFilters) => { setFilters(newFilters); };
        
        const filteredCompanyGroups = useMemo(() => {
            const hasActiveFilters = Object.values(filters).some(val => val && val.trim() !== '');
            if (!hasActiveFilters) return companyGroups;

            const filteredCompanies = allCompanies.filter(company => {
                const searchTerm = filters.searchTerm.toLowerCase().trim();
                const city = company.city || '';
                const district = company.district || '';
                const sector = company.sector || '';
                const searchTermMatch = searchTerm ? `${company.name} ${company.address} ${company.phone}`.toLowerCase().includes(searchTerm) : true;
                const cityMatch = filters.city ? city.toLowerCase().includes(filters.city.toLowerCase().trim()) : true;
                const districtMatch = filters.district ? district.toLowerCase().includes(filters.district.toLowerCase().trim()) : true;
                const sectorMatch = filters.sector ? sector.toLowerCase().includes(filters.sector.toLowerCase().trim()) : true;
                const statusMatch = filters.status ? company.status === filters.status : true;
                return searchTermMatch && cityMatch && districtMatch && sectorMatch && statusMatch;
            });

            const newGroups = {};
            filteredCompanies.forEach(company => {
                const groupName = `${company.city} - ${company.district} - ${company.sector}`;
                if (!newGroups[groupName]) newGroups[groupName] = [];
                newGroups[groupName].push(company);
            });
            return newGroups;
        }, [allCompanies, companyGroups, filters]);
        
        const filteredCompaniesFlat = useMemo(() => Object.values(filteredCompanyGroups).flat(), [filteredCompanyGroups]);

        const handleDeleteCompany = (id) => {
            if(window.confirm("Bu firmayı kalıcı olarak silmek istediğinizden emin misiniz?")){
                setCompanyGroups(prevGroups => {
                    const newGroups = { ...prevGroups };
                    let groupToDelete = null;
                    for (const groupName in newGroups) {
                        const originalLength = newGroups[groupName].length;
                        newGroups[groupName] = newGroups[groupName].filter(c => c.id !== id);
                        if (newGroups[groupName].length < originalLength) {
                            if (newGroups[groupName].length === 0) groupToDelete = groupName;
                            break; 
                        }
                    }
                    if(groupToDelete) delete newGroups[groupToDelete];
                    return newGroups;
                });
            }
        };

        const handleDeleteGroup = (groupName) => {
            setCompanyGroups(prevGroups => {
                const newGroups = {...prevGroups};
                delete newGroups[groupName];
                return newGroups;
            });
        };
        
        const handleStatusChange = (id, newStatus) => {
            setCompanyGroups(prevGroups => {
                const newGroups = { ...prevGroups };
                for (const groupName in newGroups) {
                    newGroups[groupName] = newGroups[groupName].map(c => c.id === id ? { ...c, status: newStatus } : c);
                }
                return newGroups;
            });
        };

        const handleDeleteStagedCompany = (id) => setStagedCompanies(prev => prev.filter(c => c.id !== id));
        
        const handleArchiveAllStaged = () => {
            if (stagedCompanies.length > 0) {
                const allArchivedPhones = new Set(allCompanies.map(c => c.phone));
                const uniqueStagedCompanies = [...new Map(stagedCompanies.map(item => [item['phone'], item])).values()];
                const duplicateCountInStaging = stagedCompanies.length - uniqueStagedCompanies.length;
                const trulyNewCompanies = [];
                let skippedCount = 0;
                
                for (const stagedCompany of uniqueStagedCompanies) {
                    if (!allArchivedPhones.has(stagedCompany.phone)) trulyNewCompanies.push(stagedCompany);
                    else skippedCount++;
                }
                skippedCount += duplicateCountInStaging;

                if (trulyNewCompanies.length > 0) {
                    const groupName = `${targetArchive.city} - ${targetArchive.district} - ${targetArchive.sector}`;
                    setCompanyGroups(prevGroups => {
                        const newGroups = { ...prevGroups };
                        const existingGroup = newGroups[groupName] || [];
                        newGroups[groupName] = [...existingGroup, ...trulyNewCompanies];
                        return newGroups;
                    });
                    
                    let successMessage = `${trulyNewCompanies.length} yeni firma başarıyla arşive eklendi.`;
                    if (skippedCount > 0) successMessage += ` ${skippedCount} firma aynı telefon numarasına sahip olduğu için atlandı.`;
                    displaySuccess(successMessage);
                } else if (skippedCount > 0) displayError(`Arşivleme başarısız. Gelen kutusundaki ${skippedCount} firmanın tamamı zaten arşivde mevcut.`);
                setStagedCompanies([]);
            }
        };

        const handleDeleteAllStaged = () => { if(stagedCompanies.length > 0 && window.confirm(`${stagedCompanies.length} firmanın tümünü gelen kutusundan silmek istediğinizden emin misiniz?`)) setStagedCompanies([]); };
        
        const blobToBase64 = (blob) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(blob); });

        const commonExtractionPrompt = `Sen uzman bir veri çıkarma asistanısın. Aşağıdaki girdiden firma bilgilerini çıkar. Tek bir "companies" anahtarı içeren ve bu anahtarın değerinin firma nesnelerinden oluşan bir dizi olduğu geçerli bir JSON nesnesi döndür. Her firma nesnesi şu anahtarları MUTLAKA içermelidir: "name", "address", "phone". Bir değer hiçbir şekilde bulunamazsa, "Belirtilmemiş" dizesini kullan. Sadece telefon numarası ("phone") olan firmaları listeye dahil et. Metinde hiç firma bulunamazsa, boş bir "companies" dizisi döndür. Herhangi bir açıklama ekleme, sadece JSON nesnesini döndür.`;
        const commonResponseSchema = { type: 'OBJECT', properties: { companies: { type: 'ARRAY', items: { type: 'OBJECT', properties: { name: { type: 'STRING', description: 'Firma adı' }, address: { type: 'STRING', description: 'Tam adres' }, phone: { type: 'STRING', description: 'Telefon numarası' }, }, required: ["name", "phone", "address"] } } } };
        
        const processApiResponse = (parsedData, currentTargetArchive) => {
            if (!parsedData.companies || !Array.isArray(parsedData.companies)) throw new Error("API'den beklenen formatta veri alınamadı.");

            const foundCompanies = parsedData.companies.filter(comp => comp.phone && comp.phone.toLowerCase() !== 'belirtilmemiş' && comp.phone.toLowerCase() !== 'n/a').map(comp => ({ ...comp, id: `${Date.now()}-${Math.random()}`, name: comp.name || 'Belirtilmemiş', address: comp.address || 'Belirtilmemiş', status: 'Aranacak', ...currentTargetArchive }));
            if (foundCompanies.length === 0) throw new Error("Geçerli telefon numarasına sahip yeni bir firma bulunamadı.");
            
            const allArchivedPhones = new Set(Object.values(companyGroups).flatMap(group => group.map(c => c.phone)));
            const existingStagedPhones = new Set(stagedCompanies.map(c => c.phone));
            const uniqueNewCompanies = [];
            let duplicateCount = 0;

            for (const company of foundCompanies) {
                if (!allArchivedPhones.has(company.phone) && !existingStagedPhones.has(company.phone)) { uniqueNewCompanies.push(company); existingStagedPhones.add(company.phone); } 
                else { duplicateCount++; }
            }

            if (uniqueNewCompanies.length > 0) { setStagedCompanies(prev => [...prev, ...uniqueNewCompanies]); let successMessage = `${uniqueNewCompanies.length} yeni firma bulundu ve gelen kutusuna eklendi.`; if (duplicateCount > 0) successMessage += ` ${duplicateCount} firma zaten mevcut olduğu için atlandı.`; displaySuccess(successMessage); } 
            else { const errorMessage = `Aktarım başarısız. Bulunan ${duplicateCount > 0 ? duplicateCount + ' ' : ''}firmanın tamamı zaten mevcut.`; displayError(errorMessage); }
        };

        const preImportChecks = () => {
             setGlobalError(null); setGlobalSuccess(null);
            if (!apiKey) { displayError("Lütfen firma aktarmadan önce API anahtarınızı girip kaydedin."); return false; }
            if (!isTargetArchiveValid) { displayError("Lütfen aktarım yapmadan önce hedef arşiv için tüm alanları (Şehir, İlçe, Sektör) doldurun."); return false; }
            return true;
        }

        const handleImageImport = async (file, callback) => {
            if (!preImportChecks()) return;
            setLoadingSource('image');
            try {
                const base64Data = await blobToBase64(file);
                const ai = new GoogleGenAI({ apiKey: apiKey });
                const imagePart = { inlineData: { mimeType: file.type, data: base64Data } };
                const textPart = { text: commonExtractionPrompt };
                const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: { parts: [imagePart, textPart] }, config: { responseMimeType: "application/json", responseSchema: commonResponseSchema } });
                const parsedData = JSON.parse(response.text.trim());
                processApiResponse(parsedData, targetArchive);
                if(callback) callback();
            } catch (error) { console.error("Resimden veri aktarma hatası:", error); const msg = error instanceof Error ? `Detay: ${error.message}` : ''; displayError(`Veri alınamadı. ${msg}`); } finally { setLoadingSource(null); }
        };

         const handleTextImport = async (text, callback) => {
            if (!preImportChecks()) return;
            setLoadingSource('text');
            try {
                const ai = new GoogleGenAI({ apiKey: apiKey });
                const prompt = `${commonExtractionPrompt}\n\nMetin:\n---\n${text}\n---`;
                const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt, config: { responseMimeType: "application/json", responseSchema: commonResponseSchema } });
                const parsedData = JSON.parse(response.text.trim());
                processApiResponse(parsedData, targetArchive);
                if(callback) callback();
            } catch (error) { console.error("Metinden veri aktarma hatası:", error); const msg = error instanceof Error ? `Detay: ${error.message}` : ''; displayError(`Veri alınamadı. ${msg}`); } finally { setLoadingSource(null); }
        };

        return (
          <div className="min-h-screen text-gray-800 dark:text-gray-200 transition-colors duration-300">
            <div className="container mx-auto p-4 sm:p-6 lg:p-8 pb-20">
              {activePage !== 'whatsapp_pro' && (
                  <div className="flex flex-col lg:flex-row justify-between items-start gap-8 pb-4 mb-8 border-b border-gray-200 dark:border-gray-700">
                    <Header />
                    <div className="w-full lg:flex-grow grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <APIKeyManager apiKey={apiKey} setApiKey={setApiKey} />
                        <DataTransferManager companyGroups={companyGroups} setCompanyGroups={setCompanyGroups} displaySuccess={displaySuccess} displayError={displayError} />
                    </div>
                  </div>
              )}
              
              <PageNavigator activePage={activePage} setActivePage={setActivePage} />

              <main>
                  {activePage === 'management' && (
                      <ManagementPage
                          targetArchive={targetArchive} setTargetArchive={setTargetArchive}
                          handleImageImport={handleImageImport} handleTextImport={handleTextImport}
                          loadingSource={loadingSource} apiKey={apiKey} isTargetArchiveValid={isTargetArchiveValid}
                          globalError={globalError} globalSuccess={globalSuccess}
                          stagedCompanies={stagedCompanies}
                          handleArchiveAllStaged={handleArchiveAllStaged}
                          handleDeleteStagedCompany={handleDeleteStagedCompany}
                          handleDeleteAllStaged={handleDeleteAllStaged}
                          filters={filters} handleFilterChange={handleFilterChange}
                          filteredCompaniesFlat={filteredCompaniesFlat}
                          filteredCompanyGroups={filteredCompanyGroups}
                          handleDeleteCompany={handleDeleteCompany}
                          handleStatusChange={handleStatusChange}
                          handleDeleteGroup={handleDeleteGroup}
                          allCompanies={allCompanies}
                      />
                  )}
                  {activePage === 'analytics' && (
                      <AnalyticsPage
                          allCompanies={allCompanies}
                          onDelete={handleDeleteCompany}
                          onStatusChange={handleStatusChange}
                      />
                  )}
                  {activePage === 'whatsapp_pro' && (
                      <WhatsAppProPage 
                          allCompanies={allCompanies} 
                          companyGroups={companyGroups} 
                      />
                  )}
              </main>
              
              <StorageStatus status={saveStatus} itemCount={allCompanies.length} />
            </div>
          </div>
        );
      };

      // --- RENDER ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>